# 商店管理员照片修改问题诊断脚本

## 问题分析

根据代码检查，商店管理员修改照片无法保存到数据库的可能原因：

### 1. 图片文件保存问题
- **路径权限问题**: 服务端可能没有写入权限到图片目录
- **目录不存在**: `vcampus-database/src/main/resources/db_img/products/` 目录可能不存在
- **文件格式问题**: 只支持PNG格式，其他格式会被拒绝

### 2. 数据库更新问题
- **事务提交问题**: 数据库事务可能没有正确提交
- **SQL执行失败**: MyBatis映射可能有问题
- **字段映射问题**: imagePath字段可能没有正确映射

### 3. 网络传输问题
- **图片数据过大**: 图片文件可能太大，导致网络传输失败
- **序列化问题**: 图片字节数组可能没有正确序列化

## 调试步骤

### 步骤1: 检查服务端日志
在服务端控制台查看以下日志：
```
商品图片已更新到: /db_img/products/xxx.png
图片已保存: D:\Desktop\vcampus\vcampus-database\src\main\resources\db_img\products\xxx.png
相对路径: /db_img/products/xxx.png
```

### 步骤2: 检查图片目录
确认以下目录存在且有写入权限：
```
D:\Desktop\vcampus\vcampus-database\src\main\resources\db_img\products\
```

### 步骤3: 检查数据库更新
在数据库中执行以下SQL检查：
```sql
SELECT id, name, imagePath FROM vcampus_db.tb_product WHERE id = [商品ID];
```

### 步骤4: 检查客户端日志
在客户端控制台查看：
```
图片文件大小: xxx bytes
更新图片数据，大小: xxx bytes
成功发送商品更新请求
```

## 解决方案

### 方案1: 修复图片保存路径
如果图片保存失败，可以修改`ShopService.java`中的路径：

```java
// 修改为更简单的路径
Path imageDir = Paths.get("images", "products");
```

### 方案2: 添加错误处理
在`ProductEditViewController.java`中添加更详细的错误处理：

```java
if (selectedImageFile != null) {
    try {
        byte[] imageData = java.nio.file.Files.readAllBytes(selectedImageFile.toPath());
        product.setImageData(imageData);
        System.out.println("图片数据设置成功，大小: " + imageData.length + " bytes");
    } catch (Exception e) {
        System.err.println("读取图片文件失败: " + e.getMessage());
        e.printStackTrace(); // 添加详细错误信息
        showError("读取图片文件失败: " + e.getMessage());
        return;
    }
}
```

### 方案3: 检查文件格式
确保选择的图片文件是PNG格式，或者修改代码支持更多格式：

```java
// 支持更多图片格式
FileChooser.ExtensionFilter imageFilter = new FileChooser.ExtensionFilter("图片文件", "*.png", "*.jpg", "*.jpeg");
fileChooser.getExtensionFilters().add(imageFilter);
```

### 方案4: 数据库调试
在`ShopDao.java`中添加调试信息：

```java
@Override
public boolean updateProductById(Product product) {
    try (SqlSession sqlSession = MyBatisUtil.openSession()) {
        ShopMapper shopMapper = sqlSession.getMapper(ShopMapper.class);
        System.out.println("更新商品: " + product.getId() + ", 图片路径: " + product.getImagePath());
        boolean result = shopMapper.updateProductById(product);
        sqlSession.commit();
        System.out.println("数据库更新结果: " + result);
        return result;
    } catch (Exception e) {
        e.printStackTrace();
        return false;
    }
}
```

## 快速修复建议

1. **检查图片目录权限**: 确保服务端有写入权限
2. **使用小图片测试**: 选择小于1MB的PNG图片进行测试
3. **查看控制台日志**: 重点关注图片保存和数据库更新的日志
4. **检查数据库连接**: 确保数据库连接正常

## 测试步骤

1. 选择一个小的PNG图片文件（<100KB）
2. 在商品编辑页面点击"选择图片"
3. 选择图片后查看预览是否正常
4. 点击"更新"按钮
5. 查看服务端和客户端控制台日志
6. 检查数据库中imagePath字段是否更新

如果问题仍然存在，请提供具体的错误日志信息。
