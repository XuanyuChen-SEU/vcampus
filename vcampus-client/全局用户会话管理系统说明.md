# 全局用户会话管理系统

## 概述

本系统为VCampus客户端应用程序提供了一个全局用户会话管理功能，允许在登录后在整个应用程序中跟踪和访问当前用户的信息。

## 核心组件

### 1. UserSession 类
- **位置**: `com.vcampus.client.session.UserSession`
- **功能**: 单例模式的用户会话管理器
- **职责**: 
  - 保存当前登录用户的ID和角色
  - 提供用户状态查询方法
  - 管理登录/登出状态

### 2. 主要方法

#### 获取用户信息
```java
// 获取当前用户ID
String userId = UserSession.getInstance().getCurrentUserId();

// 获取当前用户角色
Role role = UserSession.getInstance().getCurrentUserRole();

// 获取用户显示名称（格式：角色 + ID）
String displayName = UserSession.getInstance().getCurrentUserDisplayName();
```

#### 状态检查
```java
// 检查是否已登录
boolean isLoggedIn = UserSession.getInstance().isLoggedIn();

// 检查是否具有特定角色
boolean isStudent = UserSession.getInstance().hasRole(Role.STUDENT);
```

#### 会话管理
```java
// 设置当前用户（登录时调用）
UserSession.getInstance().setCurrentUser("1234567");

// 清除会话（登出时调用）
UserSession.getInstance().clearSession();
```

## 使用方式

### 1. 在控制器中获取用户信息

```java
public class SomeController {
    public void someMethod() {
        UserSession userSession = MainApp.getGlobalUserSession();
        
        if (userSession.isLoggedIn()) {
            String userId = userSession.getCurrentUserId();
            Role role = userSession.getCurrentUserRole();
            
            // 根据用户信息进行相应处理
            if (role == Role.STUDENT) {
                // 学生相关逻辑
            } else if (role == Role.TEACHER) {
                // 教师相关逻辑
            }
        }
    }
}
```

### 2. 权限控制示例

```java
public boolean canAccessFeature(String feature) {
    UserSession userSession = MainApp.getGlobalUserSession();
    
    if (!userSession.isLoggedIn()) {
        return false;
    }
    
    Role role = userSession.getCurrentUserRole();
    
    switch (feature) {
        case "student_records":
            return role == Role.STUDENT || role == Role.ADMIN;
        case "library_management":
            return role == Role.ADMIN;
        case "store_purchase":
            return true; // 所有用户都可以购买
        default:
            return false;
    }
}
```

## 集成说明

### 1. 登录流程集成
在 `LoginController.handleLoginResult()` 方法中，登录成功后会自动保存用户信息：

```java
private void handleLoginResult(Message result) {
    if (result.isSuccess()) {
        // 获取用户名并保存到全局会话
        String username = usernameField.getText().trim();
        UserSession.getInstance().setCurrentUser(username);
        
        // 其他登录成功处理...
    }
}
```

### 2. 主界面显示
在 `MainViewController` 中，会自动显示当前用户信息：

```java
private void updateUserInfo() {
    if (userInfoLabel != null) {
        UserSession userSession = MainApp.getGlobalUserSession();
        if (userSession.isLoggedIn()) {
            userInfoLabel.setText("当前用户: " + userSession.getCurrentUserDisplayName());
        } else {
            userInfoLabel.setText("未登录");
        }
    }
}
```

## 用户角色说明

根据用户ID的第一位数字确定角色：
- **1**: 学生 (STUDENT)
- **2**: 教师 (TEACHER)  
- **3**: 管理员 (ADMIN)

例如：
- 用户ID "1234567" → 学生
- 用户ID "2234567" → 教师
- 用户ID "3234567" → 管理员

## 注意事项

1. **线程安全**: UserSession 使用 synchronized 方法确保线程安全
2. **单例模式**: 整个应用程序中只有一个 UserSession 实例
3. **自动角色解析**: 根据用户ID自动解析用户角色
4. **状态持久性**: 用户会话在整个应用程序生命周期中保持有效
5. **登出处理**: 需要在登出时调用 `clearSession()` 方法

## 扩展建议

1. **添加更多用户信息**: 可以扩展 UserSession 来保存更多用户详细信息
2. **会话超时**: 可以添加会话超时机制
3. **多用户支持**: 如果需要支持多用户同时登录，可以考虑使用不同的设计模式
4. **权限系统**: 可以基于角色构建更复杂的权限控制系统
