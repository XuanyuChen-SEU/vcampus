# 数据库接口操作手册



#前倾提要:
## 请务必记住mysql安装时候设置的用户名和密码
###  
## 开始流程

### **1. 数据库初始化**
打开
* 1.vcampus-database/src/main/resources/mybatis-config.xml
* 2.vcampus-server/src/main/resources/mybatis-config.xml
*
* 在这部分设置
* property name="driver" value="com.mysql.cj.jdbc.Driver"/
* property name="url" value="jdbc:mysql://localhost:3306/vcampus_db?useSSL=false&amp;serverTimezone=UTC"/
* property name="username" value=""/
* property name="password" value=""/
  在这里的username和password需要和mysql安装时候设置的用户名和密码保持一致。



### **2. maven编译**

```bash
mvn clean install
```
在进行客户端的启动



## 1. 文档概述

本文档用于详细说明 `IUserDao` 接口及其实现类 `UserDao` 的功能、使用方法、依赖条件与注意事项，帮助开发人员快速理解并正确集成该接口到 `vcampus` 系统中，实现用户数据的初始化、查询、更新与删除操作。

### 1.2 适用范围

- 负责 `vcampus` 系统用户模块开发、维护的技术人员
- 需要对接用户数据访问层（DAO）的下游模块开发人员
- 系统测试与部署人员（需了解初始化流程）

## 3. IUserDao 接口方法详解

`IUserDao` 接口定义了 5 个核心方法，覆盖用户数据从初始化到资源回收的全流程，所有方法均由 `UserDao` 实现，以下为每个方法的详细说明。

### 3.1 初始化方法：UDInit()

#### 功能描述

- 自动执行数据库初始化流程：删除旧库 → 创建新库 → 初始化表结构与数
- 初始化表结构的两种模式：1.读取vcampus-database/src/main/resources/db的数据文件 2.执行生成数据库文件命令

### 3.2 查询方法：getUserById(String id)

#### 功能描述

根据用户 ID（7 位 String 类型）查询单个用户的完整信息，返回 `User` 对象。

#### 参数说明

| 参数名 | 类型   | 约束条件                     | 示例值    |
| ------ | ------ | ---------------------------- | --------- |
| id     | String | 必须为 7 位字符，不可为 null | "0012345" |

#### 返回值

- 若查询到匹配用户，返回 `User` 对象（包含 `userId`、`password` 等完整字段）。
- 若未查询到用户，返回 `null`。

### 3.3 更新方法：updateUser(User user)

#### 功能描述

根据 `User` 对象中的 `userId`，更新该用户的密码（当前仅支持密码更新，若需扩展其他字段需修改 `UserMapper`）。

#### 参数说明

| 参数名 | 类型 | 约束条件                                                                                          |
| ------ | ---- | ------------------------------------------------------------------------------------------------- |
| user   | User | -`userId` 不可为 null/空，必须为 7 位 String`<br>`- `password` 为加密后的密文（需提前处理） |

#### 返回值

- `true`：更新成功（影响行数 ≥ 1）。
- `false`：更新失败（未找到匹配 `userId` 的用户，影响行数 = 0）。

### 3.4 删除方法：deleteUser(User user)

#### 功能描述

根据 `User` 对象中的 `userId`，删除对应的用户记录。

#### 参数说明

| 参数名 | 类型 | 约束条件                               |
| ------ | ---- | -------------------------------------- |
| user   | User | `userId` 不可为 null/空，7 位 String |

#### 返回值

- 固定返回 `true`（当前实现未判断删除是否成功，若需严谨性需修改为“根据影响行数返回布尔值”）。

### 3.5 资源关闭方法：UDClose()

#### 功能描述

关闭 `SqlSession` 资源，避免数据库连接泄漏（**必须在使用完 `IUserDao` 后调用**）。

## 4. 数据库原理接口使用指南(可选，对于底层开发人员具有帮助)

# UserMapper接口使用手册

## 4.1. 接口概述

`UserMapper` 是数据库操作的接口，提供了与用户相关的数据库表管理、数据增删改查等功能，通过接口方法可直接操作用户数据及数据库结构，无需关注底层实现细节。

## 4.2. 方法详情

### 4.2.1 数据库管理方法

#### 4.2.1.1 `void createDatabase(String dbName)`

- **功能**：创建指定名称的数据库（若不存在），数据库采用 `utf8mb4` 字符集及对应排序规则。
- **参数**：`dbName`（字符串），需创建的数据库名称。
- **示例**（参考UserDao）：
  ```java
  // 创建名为"vcampus_db"的数据库
  usermapper.createDatabase("vcampus_db");
  ```

#### 4.2.1.2 `void dropDatabase(String dbName)`

- **功能**：删除指定名称的数据库（若存在）。
- **参数**：`dbName`（字符串），需删除的数据库名称。
- **示例**（参考UserDao）：
  ```java
  // 删除名为"vcampus_db"的数据库
  usermapper.dropDatabase("vcampus_db");
  ```

### 4.2.2 用户表管理方法

#### 4.2.2.1 `void createUserTable()`

- **功能**：在数据库中创建用户表（`tb_user`），表结构包含：
  - `userId`：字符串类型（50位），主键，存储7位数字用户ID；
  - `password`：字符串类型（50位），存储用户密码（7位数字）。
- **参数**：无。
- **示例**（参考UserDao）：
  ```java
  // 创建用户表tb_user
  usermapper.createUserTable();
  ```

#### 4.2.2.2 `void dropUserTable(String dbName)`

- **功能**：删除数据库中的用户表（`tb_user`，若存在）。
- **参数**：`dbName`（字符串），数据库名称（用于定位表所在数据库）。
- **示例**：
  ```java
  // 删除vcampus_db中的tb_user表
  usermapper.dropUserTable("vcampus_db");
  ```

### 4.2.3 测试数据操作方法

#### 4.2.3.1 `void InsertTempData()`

- **功能**：向用户表中插入固定的测试数据，包含5条用户记录（`userId`和 `password`均为7位数字字符串）。
- **参数**：无。
- **示例**（参考UserDao）：
  ```java
  // 插入测试数据
  usermapper.InsertTempData();
  // 提交事务（需配合SqlSession使用）
  sqlSession.commit();
  ```

### 4.2.4 数据查询方法

#### 4.2.4.1 `List<User> selectAll()`

- **功能**：查询用户表中所有用户的信息。
- **返回值**：`List<User>`，包含所有用户的列表（`User`对象包含 `userId`和 `password`属性）。
- **示例**：
  ```java
  // 查询所有用户
  List<User> allUsers = usermapper.selectAll();
  ```

#### 4.2.4.2 `User selectById(String userId)`

- **功能**：根据用户ID（`userId`）查询单个用户的信息。
- **参数**：`userId`（字符串），目标用户的7位数字ID。
- **返回值**：`User`，匹配 `userId`的用户对象；若不存在，返回 `null`。
- **示例**（参考UserDao）：
  ```java
  // 查询ID为"1234567"的用户
  User user = usermapper.selectById("1234567");
  ```

#### 4.2.4.3 `List<User> selectByCondition(Map map)`

- **功能**：根据Map中的条件查询用户，支持多条件组合（目前支持 `userId`精确匹配和 `password`模糊匹配）。
- **参数**：`map`（Map），键为条件名（`"userId"`或 `"password"`），值为条件值。
- **返回值**：`List<User>`，符合所有条件的用户列表。
- **示例**：
  ```java
  // 查询userId为"1234567"且password包含"765"的用户
  Map<String, String> condition = new HashMap<>();
  condition.put("userId", "1234567");
  condition.put("password", "%765%");
  List<User> users = usermapper.selectByCondition(condition);
  ```

#### 4.2.4.4 `List<User> selectBySingleCondition(User user)`

- **功能**：根据 `User`对象中的单个条件查询用户（优先匹配 `userId`，若 `userId`为空则匹配 `password`模糊查询）。
- **参数**：`user`（User），需包含 `userId`或 `password`作为查询条件。
- **返回值**：`List<User>`，符合条件的用户列表。
- **示例**：
  ```java
  // 按password模糊查询（userId为空时）
  User conditionUser = new User();
  conditionUser.setPassword("%765%");
  List<User> users = usermapper.selectBySingleCondition(conditionUser);
  ```

### 4.2.5 数据新增方法

#### 4.2.5.1 `void add(User user)`

- **功能**：向用户表中新增一条用户记录。
- **参数**：`user`（User），需包含 `userId`（7位数字字符串）和 `password`（7位数字字符串）。
- **示例**：
  ```java
  // 新增用户
  User newUser = new User();
  newUser.setUserId("6789012");
  newUser.setPassword("2109876");
  usermapper.add(newUser);
  sqlSession.commit(); // 提交事务
  ```

### 4.2.6 数据更新方法

#### 4.2.6.1 `int update(User user)`

- **功能**：根据 `userId`更新用户的密码（仅支持更新 `password`字段）。
- **参数**：`user`（User），需包含 `userId`（定位用户）和新的 `password`。
- **返回值**：`int`，受影响的行数（1表示更新成功，0表示用户不存在）。
- **示例**（参考UserDao）：
  ```java
  // 更新用户密码
  User updateUser = new User();
  updateUser.setUserId("1234567");
  updateUser.setPassword("newPassword");
  int result = usermapper.update(updateUser);
  sqlSession.commit(); // 提交事务
  boolean isSuccess = result > 0; // 判断是否更新成功
  ```

### 4.2.7 数据删除方法

#### 4.2.7.1 `void deleteById(String userId)`

- **功能**：根据 `userId`删除单个用户记录。
- **参数**：`userId`（字符串），目标用户的ID。
- **示例**（参考UserDao）：
  ```java
  // 删除ID为"1234567"的用户
  usermapper.deleteById("1234567");
  sqlSession.commit(); // 提交事务
  ```

#### 4.2.7.2 `void deleteByIds(String[] userIds)`

- **功能**：批量删除多个用户记录（根据数组中的 `userId`）。
- **参数**：`userIds`（字符串数组），包含多个目标用户的ID。
- **示例**：
  ```java
  // 批量删除用户
  String[] ids = {"1234567", "2345678"};
  usermapper.deleteByIds(ids);
  sqlSession.commit(); // 提交事务
  ```

## 4.3. 使用注意事项

1. 所有涉及数据修改的操作（新增、更新、删除、插入测试数据）需调用 `SqlSession.commit()`提交事务，否则修改不会生效。
2. 方法调用前需确保数据库和表已通过 `createDatabase`和 `createUserTable`创建。
3. `userId`和 `password`均为7位数字字符串，使用时需符合格式要求。
4. 操作完成后建议调用 `SqlSession.close()`关闭会话，释放资源。

# 5.UserDao 类说明指南(可选)

## 一、类概述

`UserDao` 类位于 `com.vcampus.server.dao.impl` 包下，是用户数据访问层的实现类，实现了 `IUserDao` 接口。该类基于 MyBatis 框架实现对用户数据的持久化操作，主要负责数据库初始化、用户信息的查询、更新、删除等功能，同时处理数据库表结构及初始数据的加载。

## 二、核心依赖与变量说明

### 1. 依赖组件

- MyBatis 框架：用于数据库操作的 ORM 框架，通过 `SqlSession`、`SqlSessionFactory` 实现与数据库的交互
- `UserMapper`：MyBatis 映射接口，定义数据库操作的 SQL 映射方法
- `SqlFileExecutor`：用于执行 SQL 文件的工具类
- `User`：用户数据传输对象（DTO），封装用户信息（如用户 ID、密码等）

### 2. 主要变量

| 变量名                | 类型              | 说明                                           |
| --------------------- | ----------------- | ---------------------------------------------- |
| `resource`          | String            | MyBatis 配置文件路径（`mybatis-config.xml`） |
| `inputStream`       | InputStream       | 配置文件输入流                                 |
| `sqlSessionFactory` | SqlSessionFactory | MyBatis 会话工厂，用于创建 `SqlSession`      |
| `sqlSession`        | SqlSession        | MyBatis 会话对象，用于执行数据库操作           |
| `usermapper`        | UserMapper        | 数据库操作映射接口实例                         |
| `sqlFileExecutor`   | SqlFileExecutor   | 执行 SQL 文件的工具类实例                      |
| `dbName`            | String            | 数据库名称（默认 `vcampus_db`）              |
| `sqlFilePath`       | String            | 初始化 SQL 文件路径（默认 `db/tb_user.sql`） |

## 三、核心方法说明

### 1. 构造方法 `UserDao()`

- 功能：实例化 `UserDao` 时自动调用 `UDInit()` 方法完成初始化操作
- 调用流程：`new UserDao()` → 触发 `UDInit()`

### 2. 初始化方法 `UDInit()`

该方法是核心初始化逻辑，主要完成以下操作：

1. **加载 MyBatis 配置**：读取 `mybatis-config.xml` 配置文件，创建 `SqlSessionFactory` 和 `SqlSession`，并获取 `UserMapper` 实例
2. **数据库初始化**：
   - 删除并重新创建数据库 `vcampus_db`（确保环境干净）
   - 检查 `sqlFilePath` 对应的 SQL 文件是否存在（通过 `checkSqlFileExists` 方法）
3. **表结构与数据初始化**：
   - 若 SQL 文件存在：通过 `sqlFileExecutor` 执行 SQL 文件，初始化表结构和数据
   - 若 SQL 文件不存在：调用 `usermapper.createUserTable()` 创建用户表，再调用 `usermapper.InsertTempData()` 插入默认测试数据（7位数字用户ID）
4. **异常处理**：捕获初始化过程中的异常，打印堆栈并抛出 `RuntimeException`

### 3. 数据操作方法

#### （1）`getUserById(String id)`

- 功能：根据用户 ID 查询用户信息
- 参数：`id` - 用户 ID（String 类型，避免首位 0 丢失）
- 返回值：`User` 对象 - 包含用户详细信息

#### （2）`updateUser(User user)`

- 功能：更新用户信息（核心更新密码，可扩展其他字段）
- 参数：`user` - 包含更新信息的 User 对象（需包含用户 ID 和新密码）
- 逻辑：
  - 从 `user` 中提取用户 ID 和密码
  - 调用 `usermapper.update(user)` 执行更新
  - 提交事务（`sqlSession.commit()`）
- 返回值：`boolean` - 更新成功（影响行数 > 0 则返回 true）

#### （3）`deleteUser(User user)`

- 功能：根据用户 ID 删除用户
- 参数：`user` - 包含待删除用户 ID 的 User 对象
- 逻辑：
  - 提取用户 ID，调用 `usermapper.deleteById(userId)` 执行删除
  - 提交事务（`sqlSession.commit()`）
- 返回值：`boolean` - 固定返回 true（可根据实际需求优化为基于影响行数判断）

### 4. 资源关闭方法 `UDClose()`

- 功能：关闭 `SqlSession` 资源，避免连接泄漏
- 逻辑：若 `sqlSession` 不为 null，则调用 `sqlSession.close()`

### 5. 辅助方法 `checkSqlFileExists(String filePath)`

- 功能：检查指定路径的 SQL 文件是否存在于 resources 目录中
- 参数：`filePath` - 待检查的 SQL 文件路径
- 返回值：`boolean` - 存在返回 true，否则返回 false

## 四、使用注意事项

1. **初始化逻辑**：`UDInit()` 会删除并重建数据库，仅建议在开发/测试环境使用，生产环境需修改此逻辑
2. **用户 ID 类型**：用户 ID 使用 String 类型存储，避免首位为 0 时的数字类型自动截断问题
3. **密码处理**：代码注释提到“传输为明文和存储为密文”，实际使用时需确保密码在存储前已加密（当前代码未实现加密逻辑，需补充）
4. **事务管理**：更新和删除操作后需调用 `sqlSession.commit()` 提交事务，否则修改不会生效
5. **资源释放**：使用完毕后需调用 `UDClose()` 关闭 `SqlSession`，建议通过 try-finally 确保资源释放
6. **SQL 文件路径**：默认 SQL 文件路径为 `db/tb_user.sql`，若需修改路径，可调整 `sqlFilePath` 变量

## 五、典型使用流程

```java
// 1. 实例化 UserDao（自动初始化数据库）
UserDao userDao = new UserDao();

try {
    // 2. 查询用户
    User user = userDao.getUserById("0012345");
  
    // 3. 更新用户（例如修改密码）
    user.setPassword("newEncryptedPassword");
    boolean updateSuccess = userDao.updateUser(user);
  
    // 4. 删除用户
    boolean deleteSuccess = userDao.deleteUser(user);
} finally {
    // 5. 关闭资源
    userDao.UDClose();
}
```
